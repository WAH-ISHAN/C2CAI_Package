{"version":3,"sources":["../src/db.ts"],"sourcesContent":["import Datastore from \"nedb-promises\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\n\r\nconst dataDir = path.resolve(\".c2cai\");\r\nfs.mkdirSync(dataDir, { recursive: true });\r\n\r\nconst pagesDB = Datastore.create({ filename: path.join(dataDir, \"pages.db\"), autoload: true });\r\nconst chatsDB = Datastore.create({ filename: path.join(dataDir, \"chats.db\"), autoload: true });\r\n\r\nexport type PageRow = {\r\n  url: string;\r\n  title: string;\r\n  content: string;\r\n  embedding: number[];\r\n};\r\n\r\nexport async function upsertPage(p: PageRow) {\r\n  await pagesDB.update({ url: p.url }, p, { upsert: true });\r\n}\r\n\r\nexport async function getAllPages(): Promise<PageRow[]> {\r\n  return await pagesDB.find({});\r\n}\r\n\r\nexport async function logChat(rec: {\r\n  id: string;\r\n  ts: number;\r\n  lang: string;\r\n  user: string;\r\n  assistant: string;\r\n  sources: string[];\r\n}) {\r\n  await chatsDB.insert(rec);\r\n}\r\n\r\n// Dummy cosine similarity â€“ same as before\r\nexport function cosineSim(a: number[], b: number[]) {\r\n  let dot = 0,\r\n    na = 0,\r\n    nb = 0;\r\n  for (let i = 0; i < a.length; i++) {\r\n    const x = a[i],\r\n      y = b[i];\r\n    dot += x * y;\r\n    na += x * x;\r\n    nb += y * y;\r\n  }\r\n  return dot / (Math.sqrt(na) * Math.sqrt(nb) + 1e-8);\r\n}"],"mappings":";AAAA,OAAO,eAAe;AACtB,OAAO,QAAQ;AACf,OAAO,UAAU;AAEjB,IAAM,UAAU,KAAK,QAAQ,QAAQ;AACrC,GAAG,UAAU,SAAS,EAAE,WAAW,KAAK,CAAC;AAEzC,IAAM,UAAU,UAAU,OAAO,EAAE,UAAU,KAAK,KAAK,SAAS,UAAU,GAAG,UAAU,KAAK,CAAC;AAC7F,IAAM,UAAU,UAAU,OAAO,EAAE,UAAU,KAAK,KAAK,SAAS,UAAU,GAAG,UAAU,KAAK,CAAC;AAS7F,eAAsB,WAAW,GAAY;AAC3C,QAAM,QAAQ,OAAO,EAAE,KAAK,EAAE,IAAI,GAAG,GAAG,EAAE,QAAQ,KAAK,CAAC;AAC1D;AAEA,eAAsB,cAAkC;AACtD,SAAO,MAAM,QAAQ,KAAK,CAAC,CAAC;AAC9B;AAEA,eAAsB,QAAQ,KAO3B;AACD,QAAM,QAAQ,OAAO,GAAG;AAC1B;AAGO,SAAS,UAAU,GAAa,GAAa;AAClD,MAAI,MAAM,GACR,KAAK,GACL,KAAK;AACP,WAAS,IAAI,GAAG,IAAI,EAAE,QAAQ,KAAK;AACjC,UAAM,IAAI,EAAE,CAAC,GACX,IAAI,EAAE,CAAC;AACT,WAAO,IAAI;AACX,UAAM,IAAI;AACV,UAAM,IAAI;AAAA,EACZ;AACA,SAAO,OAAO,KAAK,KAAK,EAAE,IAAI,KAAK,KAAK,EAAE,IAAI;AAChD;","names":[]}