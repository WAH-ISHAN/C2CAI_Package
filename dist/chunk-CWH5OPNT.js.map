{"version":3,"sources":["../src/rag.ts"],"sourcesContent":["import OpenAI from \"openai\";\r\nimport { cosineSim, getAllPages } from \"./db.js\";\r\n\r\nexport async function pickContext(queryVec: number[], topK = 5) {\r\n  const pages = await getAllPages();\r\n  const scored = pages\r\n    .map((p) => ({ p, s: cosineSim(queryVec, p.embedding) }))\r\n    .sort((a, b) => b.s - a.s)\r\n    .slice(0, topK);\r\n  return scored.map((x) => x.p);\r\n}\r\n\r\nexport async function answerWithRAG(opts: {\r\n  client: OpenAI;\r\n  model: string;\r\n  embedModel: string;\r\n  question: string;\r\n  pageHint?: { url?: string; title?: string; text?: string };\r\n  allowLangs?: string[];\r\n}) {\r\n  const { client, model, embedModel, question, pageHint } = opts;\r\n\r\n  // create embedding for question\r\n  const qEmb = await client.embeddings.create({ model: embedModel, input: question });\r\n\r\n  // use top‑5 context\r\n  const contextPages = await pickContext(qEmb.data[0].embedding as number[], 5);\r\n\r\n  // build context string\r\n  const ctx = contextPages\r\n    .map(\r\n      (p, i) =>\r\n        `# Source ${i + 1}: ${p.title}\\nURL: ${p.url}\\n${p.content.slice(0, 1200)}`\r\n    )\r\n    .join(\"\\n\\n\");\r\n\r\n  const pageCtx = pageHint?.text\r\n    ? `Current Page: ${pageHint.title || \"\"} (${pageHint.url || \"\"})\\n${pageHint.text.slice(0, 1200)}`\r\n    : \"\";\r\n\r\n  const system = [\r\n    \"You are C2CAI, a helpful website assistant.\",\r\n    \"Use the given sources to answer.\",\r\n    \"If you don't know, say you don't know and suggest where to find it.\",\r\n    \"Detect user's language and respond in that language (Sinhala/English/Tamil).\",\r\n    \"Be concise, friendly, and cite sources by title/URL when helpful.\",\r\n  ].join(\" \");\r\n\r\n  const messages: any[] = [\r\n    { role: \"system\", content: system },\r\n    { role: \"user\", content: `User question:\\n${question}\\n\\nContext:\\n${ctx}\\n\\nPage Context:\\n${pageCtx}` },\r\n  ];\r\n\r\n  const resp = await client.chat.completions.create({\r\n    model,\r\n    messages,\r\n    temperature: 0.3,\r\n  });\r\n\r\n  const answer =\r\n    resp.choices[0]?.message?.content ||\r\n    \"Sorry, I couldn't generate an answer.\";\r\n\r\n  const sources = contextPages\r\n    .slice(0, 3)\r\n    .map((p) => `${p.title} — ${p.url}`);\r\n\r\n  return { answer, sources };\r\n}"],"mappings":";;;;;;AAGA,eAAsB,YAAY,UAAoB,OAAO,GAAG;AAC9D,QAAM,QAAQ,MAAM,YAAY;AAChC,QAAM,SAAS,MACZ,IAAI,CAAC,OAAO,EAAE,GAAG,GAAG,UAAU,UAAU,EAAE,SAAS,EAAE,EAAE,EACvD,KAAK,CAAC,GAAG,MAAM,EAAE,IAAI,EAAE,CAAC,EACxB,MAAM,GAAG,IAAI;AAChB,SAAO,OAAO,IAAI,CAAC,MAAM,EAAE,CAAC;AAC9B;AAEA,eAAsB,cAAc,MAOjC;AACD,QAAM,EAAE,QAAQ,OAAO,YAAY,UAAU,SAAS,IAAI;AAG1D,QAAM,OAAO,MAAM,OAAO,WAAW,OAAO,EAAE,OAAO,YAAY,OAAO,SAAS,CAAC;AAGlF,QAAM,eAAe,MAAM,YAAY,KAAK,KAAK,CAAC,EAAE,WAAuB,CAAC;AAG5E,QAAM,MAAM,aACT;AAAA,IACC,CAAC,GAAG,MACF,YAAY,IAAI,CAAC,KAAK,EAAE,KAAK;AAAA,OAAU,EAAE,GAAG;AAAA,EAAK,EAAE,QAAQ,MAAM,GAAG,IAAI,CAAC;AAAA,EAC7E,EACC,KAAK,MAAM;AAEd,QAAM,UAAU,UAAU,OACtB,iBAAiB,SAAS,SAAS,EAAE,KAAK,SAAS,OAAO,EAAE;AAAA,EAAM,SAAS,KAAK,MAAM,GAAG,IAAI,CAAC,KAC9F;AAEJ,QAAM,SAAS;AAAA,IACb;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,EAAE,KAAK,GAAG;AAEV,QAAM,WAAkB;AAAA,IACtB,EAAE,MAAM,UAAU,SAAS,OAAO;AAAA,IAClC,EAAE,MAAM,QAAQ,SAAS;AAAA,EAAmB,QAAQ;AAAA;AAAA;AAAA,EAAiB,GAAG;AAAA;AAAA;AAAA,EAAsB,OAAO,GAAG;AAAA,EAC1G;AAEA,QAAM,OAAO,MAAM,OAAO,KAAK,YAAY,OAAO;AAAA,IAChD;AAAA,IACA;AAAA,IACA,aAAa;AAAA,EACf,CAAC;AAED,QAAM,SACJ,KAAK,QAAQ,CAAC,GAAG,SAAS,WAC1B;AAEF,QAAM,UAAU,aACb,MAAM,GAAG,CAAC,EACV,IAAI,CAAC,MAAM,GAAG,EAAE,KAAK,WAAM,EAAE,GAAG,EAAE;AAErC,SAAO,EAAE,QAAQ,QAAQ;AAC3B;","names":[]}